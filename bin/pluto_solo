#!/usr/bin/env python

import logging
import os
import sys
import yaml
from pluto import *
from pluto import env as global_env
from pluto.providers import find_provider

class Pluto(object):
    def __init__(self, config):
        self.log = logging.getLogger("pluto")
        self.config = config
        self.env = global_env

        self.cookbooks = []
        for path in self.config['cookbook_paths']:
            sys.path.insert(0, path)
            for cb in os.listdir(path):
                self.cookbooks.append(cb)

    def load_cookbooks(self):
        for cb in self.cookbooks:
            load_cookbook(cb)

    def run_action(self, resource, action):
        self.log.debug("Performing action %s on %s" % (action, resource))

        provider_class = find_provider(resource.__class__.__name__, resource.provider)
        provider = provider_class(resource)
        getattr(provider, 'action_%s' % action)()

        if resource.is_updated:
            for action, res in resource.subscriptions['immediate']:
                self.log.info("%s sending %s action to %s (immediate)" % (resource, action, res))
                self.run_action(res, action)
            for action, res in resource.subscriptions['delayed']:
                self.log.info("%s sending %s action to %s (delayed)" % (resource, action, res))
            self.delayed_actions |= resource.subscriptions['delayed']

    def _check_condition(self, cond):
        if hasattr(cond, '__call__'):
            return cond()

        if isinstance(cond, basestring):
            import subprocess
            ret = subprocess.call(cond, shell=True)
            return ret == 0

        raise Exception("Unknown condition type %r" % cond)

    def run_role(self, name):
        self.delayed_actions = set()

        role = self.config['roles'][name]

        self.env.reset()
        env.set_attributes(role.get('default_attributes') or {}, overwrite=False)
        self.load_cookbooks()
        env.set_attributes(role.get('override_attributes') or {}, overwrite=True)

        for recipe in role['recipes']:
            include_recipe(recipe)

        for resource in self.env.resource_list:
            if resource.not_if is not None and self._check_condition(resource.not_if):
                self.log.debug("Skipping %s due to not_if" % resource)
                continue

            if resource.only_if is not None and not self._check_condition(resource.only_if):
                self.log.debug("Skipping %s due to only_if" % resource)
                continue

            for action in resource.action:
                self.run_action(resource, action)

        # Run delayed actions
        for action, resource in self.delayed_actions:
            self.run_action(resource, action)

def load_config(path):
    with open(path, "rb") as fp:
        config = yaml.load(fp.read())
    return config

if __name__ == "__main__":
    import sys

    import logging
    logging.basicConfig(level=logging.INFO)

    config = load_config(sys.argv[1])
    pluto = Pluto(config)
    for role in sys.argv[2:]:
        pluto.run_role(role)
